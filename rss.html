<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./vendors/bootstrap-5.3.2/css/bootstrap.css" />
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <div class="container mt-5">
      <div class="row">
        <div class="col-md-8">
          <div class="input-group mb-3">
            <input id="RSSlink" type="text" class="form-control" placeholder="RSS link" />
            <button id="fetchRSS" class="btn btn-primary" type="button">Fetch</button>
          </div>
          <div class="row">
            <div class="col-md-6">
              <h3>Old parser</h3>
              <div id="old-feed-output" class="list-group list-group-flush feed-body"></div>
            </div>
            <div class="col-md-6">
              <h3>New parser</h3>
              <div id="new-feed-output" class="list-group list-group-flush feed-body"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <h2>Quicklinks</h2>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.thebioneer.com/feed/rss/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.outerbridge.blog/1/feed</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://fs.blog/feed/<span class="badge text-bg-danger">Blocked</span></p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://stephanango.com/feed.xml</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://every.to/superorganizers/feed.xml</p>
          <p class="small text-decoration-underline" onclick="launch(this)">http://feeds.feedburner.com/scotthyoung/HAHx<span class="badge text-bg-danger">403</span></p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.eleanorkonik.com/blog/rss/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.yearzero.io/blog.rss</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://news.mit.edu/topic/mitartificial-intelligence2-rss.xml</p>
          <p class="small text-decoration-underline" onclick="launch(this)">http://markmanson.net/feed</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://alyjuma.com/rss/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://gainweightjournal.com/feed/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://collectiveintelligence.media/rss</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://kotaku.com/rss</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://theeudaimon.com/rss</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://tomcritchlow.com/feed</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://subconscious.substack.com/feed</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://thinkstack.club/rss/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://singularityhub.com/feed/</p>
          <hr />
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.dailytelegraph.com.au/news/national/rss</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.dailytelegraph.com.au/news/national/rss</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.ecodibergamo.it/feeds/latesthp/268/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.repubblica.it/rss/tecnologia/rss2.0.xml</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.dailymail.co.uk/articles.rss</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.coindesk.com/arc/outboundfeeds/rss/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://cointelegraph.com/rss<span class="badge text-bg-danger">403</span></p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://news.bitcoin.com/feed</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://decrypt.co/feed</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.investing.com/rss/news.rss</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://finance.yahoo.com/news/rssindex/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.cnbc.com/id/10000664/device/rss/rss.html</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://feeds.bbci.co.uk/news/rss.xml</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://feeds.feedburner.com/TechCrunch/<span class="badge text-bg-danger">Error</span></p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.forbes.com/innovation/feed/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml</p>
          <p class="small text-decoration-underline" onclick="launch(this)">http://rss.cnn.com/rss/edition.rss<span class="badge text-bg-danger">403</span></p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://feeds.feedburner.com/TEDTalks_video<span class="badge text-bg-danger">Error</span></p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.wired.com/feed/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.theguardian.com/uk/rss</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://feeds.a.dj.com/rss/RSSWorldNews.xml</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.technologyreview.com/feed/</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.espn.com/espn/rss/news</p>
          <p class="small text-decoration-underline" onclick="launch(this)">https://www.vox.com/rss/index.xml</p>
          <p class="small text-decoration-underline" onclick="launch(this)">www.theverge.com/rss/index.xml</p>
        </div>
      </div>
    </div>
    <script src="./js/rss-parser.min.js"></script>
    <script src="./js/utils.js"></script>
    <script>
      const actionBtn = document.getElementById("fetchRSS");
      const inputRSS = document.getElementById("RSSlink");
      const rssURL = "https://web-production-09ad.up.railway.app/";
      const oldFeedOut = document.getElementById("old-feed-output");
      const newFeedOut = document.getElementById("new-feed-output");

      function launch(el) {
        let link = el.textContent;
        console.log(link);
        inputRSS.value = link;
      }

      async function prodParser() {
        isRssLinkValid(inputRSS.value);
        await fetch(rssURL + inputRSS.value, {
          headers: {
            "Access-Control-Allow-Origin": rssURL,
            "Access-Control-Allow-Headers": "content-type",
          },
        })
          .then((response) => response.text())
          .then((str) => new window.DOMParser().parseFromString(str, "text/xml"))
          .then((data) => {
            let entries;

            if (data.querySelectorAll("item").length > 0) {
              entries = data.querySelectorAll("item");
            }
            if (data.querySelectorAll("entry").length > 0) {
              entries = data.querySelectorAll("entry");
            }

            oldFeedOut.innerHTML = "";
            let entry = "";

            if (entries.length <= 0) {
              console.log("not ok");
              entry += `
        <div class="alert alert-warning d-flex align-items-center border-0 rounded-0 p-2" role="alert">
          <img class="me-2" src="./img/warning-diamond.svg" width="20" height="20" alt="warning icon" />
          <div>
            This link seems to be invalid or the website doesn't have any RSS feed.
          </div>
        </div>
              `;
              oldFeedOut.innerHTML = entry;
            }

            entries.forEach((el) => {
              let title = el.querySelector("title").textContent;
              let link = el.querySelector("link").innerHTML;
              let description;
              if (el.querySelector("description")) {
                description = el.querySelector("description").textContent;
                strippedContent = description.replace(/<[^>]*>/g, "");
                truncatedContent = strippedContent.slice(0, 160) + "...";
              }
              let enclosure;
              if (el.querySelector("enclosure")) {
                enclosure = el.querySelector("enclosure").getAttribute("url");
              }
              let mediaContent;
              if (el.querySelector("content")) {
                mediaContent = el.querySelector("content").getAttribute("url");
                if (!mediaContent) {
                  description = el.querySelector("content").textContent;
                  strippedContent = description.replace(/<[^>]*>/g, "");
                  truncatedContent = strippedContent.slice(0, 160) + "...";
                }
              }

              let published;
              let updated;
              let pubDate;

              let elementProcessed = false;

              if (el.querySelector("published")) {
                published = convertHnDate(el.querySelector("published").innerHTML);
                elementProcessed = true;
              }

              if (!elementProcessed && el.querySelector("updated")) {
                updated = convertHnDate(el.querySelector("updated").innerHTML);
                elementProcessed = true;
              }

              if (!elementProcessed && el.querySelector("pubDate")) {
                pubDate = convertHnDate(el.querySelector("pubDate").innerHTML);
                elementProcessed = true;
              }
              entry += `
              <a href="${link}" class="list-group-item list-group-item-action" target="_blank">
              <p class="fw-semibold">${title}</p>
              ${enclosure ? `<img class="img-fluid rounded-3" src="${enclosure}" alt="${title}" loading="lazy" onError="this.onerror=null;this.src='./img/image-placeholder.png';" />` : ""}
              ${mediaContent ? `<img class="img-fluid rounded-3" src="${mediaContent}" alt="${title}" loading="lazy" onError="this.onerror=null;this.src='./img/image-placeholder.png';" />` : ""}
              ${description ? `<p class="text-secondary small text-break">${truncatedContent}</p>` : ""}
              ${pubDate ? `<p class="text-secondary small">${pubDate}</p>` : ""}
              ${published ? `<p class="text-secondary small">${published}</p>` : ""}
              ${updated ? `<p class="text-secondary small">${updated}</p>` : ""}
              </a>
              `;
            });
            oldFeedOut.innerHTML = entry;
          });
      }

      // Check RSS feed validity
      async function isRssLinkValid(rssLink) {
        try {
          const response = await fetch("https://web-production-09ad.up.railway.app/" + rssLink);
          const text = await response.text();
          // Check if the response is in a valid RSS format
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(text, "text/xml");
          if (xmlDoc.getElementsByTagName("parsererror").length === 0) {
            return true;
          } else {
            return false;
          }
        } catch (error) {
          // An error occurred during the fetch (e.g., network error)
          console.error("Error checking RSS link:", error);
          return false;
        }
      }

      // Get channel name from link
      async function getRssTitle(link) {
        console.log("Getting feed title...");
        showToast("Getting your feed...");
        const rssLink = "https://web-production-09ad.up.railway.app/" + link;

        try {
          const response = await fetch(rssLink, {
            headers: {
              "Access-Control-Allow-Origin": rssLink,
              "Access-Control-Allow-Headers": "content-type",
            },
          });

          const str = await response.text();
          const data = new window.DOMParser().parseFromString(str, "text/xml");

          let rssTitle;
          if (data.querySelector("channel")) {
            rssTitle = data.querySelector("channel").querySelector("title").textContent;
            formattedRssTitle = rssTitle.toString();
            return formattedRssTitle;
          }
          if (data.querySelector("title")) {
            rssTitle = data.querySelector("feed").querySelector("title").textContent;
            formattedRssTitle = rssTitle.toString();
            return formattedRssTitle;
          }
        } catch (error) {
          console.error("Error fetching or parsing RSS data:", error);
          throw error;
        }
      }

      async function oldParser() {
        await fetch(rssURL + inputRSS.value, {
          headers: {
            "x-request-url": rssURL,
            "Access-Control-Allow-Headers": "content-type",
          },
        })
          .then((response) => response.text())
          .then((str) => new window.DOMParser().parseFromString(str, "text/xml"))
          .then((data) => {
            let entries;

            if (data.querySelectorAll("item").length > 0) {
              entries = data.querySelectorAll("item");
            }
            if (data.querySelectorAll("entry").length > 0) {
              entries = data.querySelectorAll("entry");
            }

            oldFeedOut.innerHTML = "";
            let entry = "";

            entries.forEach((el) => {
              let title = el.querySelector("title").textContent;
              let link = el.querySelector("link").innerHTML;
              let description;
              if (el.querySelector("description")) {
                description = el.querySelector("description").textContent;
                strippedContent = description.replace(/<[^>]*>/g, "");
                truncatedContent = strippedContent.slice(0, 160) + "...";
              }
              let enclosure;
              if (el.querySelector("enclosure")) {
                enclosure = el.querySelector("enclosure").getAttribute("url");
              }
              let mediaContent;
              if (el.querySelector("content")) {
                mediaContent = el.querySelector("content").getAttribute("url");
                if (!mediaContent) {
                  description = el.querySelector("content").textContent;
                  strippedContent = description.replace(/<[^>]*>/g, "");
                  truncatedContent = strippedContent.slice(0, 160) + "...";
                }
              }
              let published;
              let updated;
              let pubDate;

              let elementProcessed = false;

              if (el.querySelector("published")) {
                published = convertHnDate(el.querySelector("published").innerHTML);
                elementProcessed = true;
              }

              if (!elementProcessed && el.querySelector("updated")) {
                updated = convertHnDate(el.querySelector("updated").innerHTML);
                elementProcessed = true;
              }

              if (!elementProcessed && el.querySelector("pubDate")) {
                pubDate = convertHnDate(el.querySelector("pubDate").innerHTML);
                elementProcessed = true;
              }

              entry += `
              <a href="${link}" class="list-group-item list-group-item-action" target="_blank">
              <p class="fw-semibold">${title}</p>
              ${enclosure ? `<img class="img-fluid rounded-3" src="${enclosure}" alt="${title}" loading="lazy" onError="this.onerror=null;this.src='./img/image-placeholder.png';" />` : ""}
              ${mediaContent ? `<img class="img-fluid rounded-3" src="${mediaContent}" alt="${title}" loading="lazy" onError="this.onerror=null;this.src='./img/image-placeholder.png';" />` : ""}
              ${description ? `<p class="text-secondary small text-break">${truncatedContent}</p>` : ""}
              ${pubDate ? `<p class="text-secondary small">${pubDate}</p>` : ""}
              ${published ? `<p class="text-secondary small">${published}</p>` : ""}
              ${updated ? `<p class="text-secondary small">${updated}</p>` : ""}
              </a>
              `;
            });
            oldFeedOut.innerHTML = entry;
          });
      }
      async function newParser() {
        let parser = new RSSParser();
        newFeedOut.innerHTML = "";

        parser.parseURL(rssURL + inputRSS.value, function (err, feed) {
          if (err) throw err;
          let output = "";

          feed.items.forEach(function (entry) {
            // console.log(entry.title + ":" + entry.link);
            strippedContent = entry.content.replace(/<[^>]*>/g, "");
            truncatedContent = strippedContent.slice(0, 160) + "...";
            output += `
              <a href="${entry.link}" class="list-group-item list-group-item-action" target="_blank">
              <p class="fw-semibold">${entry.title}</p>
              ${entry.content ? `<p class="text-secondary small text-break">${truncatedContent}</p>` : ""}
              ${entry.pubDate ? `<p class="text-secondary small">${entry.pubDate}</p>` : ""}
              </a>
              `;
          });
          newFeedOut.innerHTML = output;
        });
      }

      actionBtn.addEventListener("click", async function () {
        await newParser();
        await prodParser();
      });
    </script>
  </body>
</html>
